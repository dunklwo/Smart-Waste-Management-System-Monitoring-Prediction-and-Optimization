# =============================================================================
# Smart Waste Management System - Database Initializer (FIXED VERSION)
# =============================================================================

import sqlite3
import random
from datetime import datetime, timedelta
import os
from database import WasteDatabase

# =============================================================================
# Utility: Safe Timestamp Formatting
# =============================================================================

def ts():
    """Return current timestamp as string"""
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def ts_offset(hours):
    """Return timestamp offset by hours as string"""
    return (datetime.now() - timedelta(hours=hours)).strftime("%Y-%m-%d %H:%M:%S")

# =============================================================================
# MAIN INITIALIZER
# =============================================================================

def initialize():
    print("\n==============================================")
    print("  üóÑÔ∏è  INITIALIZING SMART WASTE SYSTEM")
    print("==============================================\n")

    # Connect DB
    db = WasteDatabase("waste_management.db")

    print("üîß STEP 1: Creating Tables...")
    db.initialize_database()

    print("‚úî Database ready!\n")

    # -------------------------------------------------------------
    # STEP 4: Generate Sample Bins + Readings + Complaints
    # -------------------------------------------------------------

    print("==============================================")
    print("üìä STEP 4: Generating Sample Data...")
    print("==============================================\n")

    try:
        print("‚Üí Generating 50 bins...\n")

        zones = ["Residential-A", "Residential-B", "Commercial", "Industrial", "Market"]
        waste_types = ["Plastic", "Organic", "Glass", "Paper", "Metal", "E-waste"]
        bin_list = []

        for i in range(1, 51):
            data = {
                "bin_id": f"BIN-{i:03}",
                "location": f"Sector-{random.randint(1, 50)}, Noida",
                "latitude": 28.6 + random.uniform(-0.03, 0.03),
                "longitude": 77.3 + random.uniform(-0.03, 0.03),
                "capacity": random.choice([150, 200, 250]),
                "waste_type": random.choice(waste_types),
                "zone": random.choice(zones),
            }
            db.insert_bin(data)
            bin_list.append(data["bin_id"])

        print("‚úî 50 bins inserted successfully!\n")

    except Exception as e:
        print("‚ùå Error generating bins:", e)

    # -------------------------------------------------------------
    # SAMPLE READINGS
    # -------------------------------------------------------------

    try:
        print("‚Üí Generating sensor readings (last 7 days)...")

        for bin_id in bin_list:
            for h in range(1, 24 * 7):  # 7 days hourly
                fill_level = random.uniform(10, 200)
                fill_percentage = min(100, (fill_level / 200) * 100)

                reading = {
                    "bin_id": bin_id,
                    "timestamp": ts_offset(h),  # FIXED TIMESTAMP
                    "fill_level": round(fill_level, 2),
                    "fill_percentage": round(fill_percentage, 2)
                }
                db.insert_reading(reading)

        print("‚úî Sensor readings inserted!\n")

    except Exception as e:
        print("‚ùå Error inserting readings:", e)

    # -------------------------------------------------------------
    # SAMPLE COMPLAINTS
    # -------------------------------------------------------------

    try:
        print("‚Üí Creating sample citizen complaints...")

        complaint_types = ["Overflow", "Bad Smell", "Damaged Bin", "Missed Collection"]
        severities = ["Low", "Medium", "High"]

        for i in range(10):
            complaint = {
                "citizen_name": f"User {i+1}",
                "contact": f"user{i+1}@gmail.com",
                "location": f"Sector {random.randint(1, 50)}, Noida",
                "bin_id": random.choice(bin_list),
                "complaint_type": random.choice(complaint_types),
                "description": "Sample autogenerated complaint.",
                "severity": random.choice(severities),
                "timestamp": ts(),  # FIXED
                "image_path": None
            }
            db.insert_complaint(complaint)

        print("‚úî Sample complaints inserted!\n")

    except Exception as e:
        print("‚ùå Error inserting complaints:", e)

    # -------------------------------------------------------------
    # DONE
    # -------------------------------------------------------------

    print("==============================================")
    print("üéâ SYSTEM INITIALIZATION COMPLETE!")
    print("==============================================\n")
    print("You can now run:")
    print("‚û° streamlit run app.py")
    print("==============================================\n")


# Run initializer
if __name__ == "__main__":
    initialize()
